<h1 id="websocket">وب‌سوکت (آزمایشی)</h1>


نوبیتکس برای ارائه اطلاعات لحظه‌ای به کاربران، از وب‌سوکت استفاده می‌کند. این سرویس با استفاده از سرور **Centrifugo** پیاده‌سازی شده است که برای زبان‌های مختلف، **SDK**های متنوعی ارائه می‌دهد تا بتوانید به راحتی در کلاینت‌های خود به وب‌سوکت متصل شوید.

لیست SDKهای قابل استفاده برای اتصال به وب‌سوکت نوبیتکس:


| ماژول SDK                                                             | مورد استفاده                                                  |
|-----------------------------------------------------------------------|---------------------------------------------------------------|
| [centrifuge-js](https://github.com/centrifugal/centrifuge-js)         | برای مرورگر، NodeJS و ReactNative                             |
| [centrifuge-python](https://github.com/centrifugal/centrifuge-python) | برای استفاده در پایتون و قدرت گرفته از asyncio                |
| [centrifuge-java](https://github.com/centrifugal/centrifuge-java)     | استفاده در جاوا و اپلیکیشن‌های Android                         |
| [centrifuge-go](https://github.com/centrifugal/centrifuge-go)         | برای Golang                                                   |
| [centrifuge-swift](https://github.com/centrifugal/centrifuge-swift)   | استفاده از اپلیکشن‌های iOS                                     |
| [centrifuge-dart](https://github.com/centrifugal/centrifuge-dart)     | برای Dart و Flutter و استفاده در توسعه‌ی موبایل و وب با آن‌ها   |


لیست SDKهای غیر رسمی:

* [centrifuge-csharp](https://github.com/charmy/centrifuge-csharp) - برای <span dir="ltr">C#</span> و <span dir="ltr">.NET</span> و <span dir="ltr">Unity 2022.3+</span>


<h2 id="websocket-connection">اتصال به وب‌سوکت</h2>

>نصب پکیج SDK با npm: 

```bash
npm install centrifuge
```

> اتصال به وب‌سوکت از طریق SDK:

```javascript
import { Centrifuge } from 'centrifuge';

const client = new Centrifuge('wss://wss.nobitex.ir/connection/websocket', {});
client.on('connected', (ctx) => {
    console.log('connected', ctx);
});
client.connect();
```

> در صورتی که از این SDK استفاده نمی‌کنید، برای اتصال به وب‌سوکت پیام زیر را ارسال نمایید:

```json
{
  "connect": {},
  "id": 1
}
```

> استفاده مستقیم در HTML؛ در انتهای body این اسکریپت را قرار دهید:

```html
<script src="https://unpkg.com/centrifuge@5.2.2/dist/centrifuge.js"></script>
```


برای اتصال به وب‌سوکت نوبیتکس، از آدرس زیر استفاده کنید:

* **آدرس وب‌سوکت:** `wss://wss.nobitex.ir/connection/websocket`
* **محدودیت نرخ:** حداکثر 100 اتصال همزمان برای هر IP
* **نیاز به ارسال توکن:** ندارد

پس از اتصال، سرور Centrifugo به صورت دوره‌ای پیام‌های `ping` ارسال می‌کند. اگر از SDKهای رسمی استفاده می‌کنید، این ابزارها به صورت خودکار به پیام‌های `ping` پاسخ `pong` می‌دهند. توجه داشته باشید که اگر در زمان ۲۵ ثانیه به پیام‌های `ping` پاسخ داده نشود، سرور به منظور مدیریت بهینه منابع، اتصال را قطع می‌کند. بنابراین اگر از SDK رسمی استفاده نمی‌کنید، از ارسال پیام `PONG` قبل از این زمان اطمینان حاصل کنید.

در صورتی‌که از SDK رسمی استفاده می‌کنید نیاز به اقدامی برای مدیریت این مکانیزم ندارید.

<aside class="notice">
مکانیزم پینگ‌پنگ به این شکل است که پیام خالی با محتوای <code>{}</code> به کلاینت ارسال شده و پیام پنگ نیز باید با همان محتوای <code>{}</code> باشد.
</aside>

### اتصال به چند کانال همزمان

برای اتصال به چند کانال به‌صورت همزمان نیاز به کلاینت‌های مجزا نیست؛ بلکه می‌توانید با استفاده از یک کلاینت به چند کانال همزمان متصل شوید.

* **محدودیت subscription به کانال‌ها:** حداکثر 300 کانال برای هر connection

> اتصال به چند کانال با استفاده از یک کلاینت:

```javascript
const channels = ['public:orderbook-BTCIRT', 'public:orderbook-USDTIRT', 'public:orderbook-FTMIRT']
const subs = channels.map(channel => {
  const sub = client.newSubscription(channel, { delta: 'fossil' })
  sub.subscribe()
  sub.on('publication', (ctx) => {
    console.log(channel, ctx.data);
  })
  return sub
});
```


### توجه: اتصال به وب‌سوکت با استفاده از SDK زبان‌های دیگر

برای مطالعه‌ی جزئیات و چگونگی اتصال به وب‌سوکت نوبیتکس با استفاده از SDK زبان‌های دیگر، لطفاً به مستنداتی که در ابتدای بخش قرار دادیم مراجعه فرمایید. در SDK ها و محیط‌های مختلف، تفاوت‌های جزئی وجود دارد. به‌طور مثال در **node.js**، نیاز به نصب و پاس دادن مستقیم ماژول `websocket` به کلاینت در هنگام اتصال می‌باشیم که در [مستندات آن SDK](https://github.com/centrifugal/centrifuge-js?tab=readme-ov-file#using-with-nodejs) به این موضوع اشاره شده.



<h2 id="websocket-orderbook">استریم لیست سفارش‌ها: اردربوک</h2>



کانال‌هایی با پیشوند زیر شامل اطلاعات **اردربوک** هستند و با هر تغییری در اردربوک، به مشترکین پیام ارسال می‌کنند:

**الگوی کانال‌های اردربوک:** <code dir="ltr">public:orderbook-*</code>



<aside class="notice">
به‌جای <code>*</code> باید سمبل بازار مربوطه را به‌شکل UPPERCASE (حروف بزرگ) قرار دهید. مثلاً <code>BTCIRT</code> و یا <code>ETHUSDT</code> و ...
</aside>


```javascript
const sub = client.newSubscription('public:orderbook-BTCIRT', { delta: 'fossil' });
sub.on('subscribed', (ctx) => {
    console.log('subscribed');
});
sub.on('publication', (ctx) => {
    console.log(ctx.data);
});
sub.subscribe();
```

> در صورتی که از SDK استفاده نمی‌کنید پیام زیر را ارسال نمایید:

```json
{
  "id": 2,
  "subscribe": {
    "channel": "public:orderbook-BTCIRT"
  }
}
```

> که در کنسول، پیامی که `console.log` نموده‌اید به شکل زیر خواهد بود که همان مقدار `data` می‌باشد:

```json
{
  "asks": [
    ["35077909990", "0.009433"], ["35078000000", "0.000274"], ["35078009660", "0.00057"]
  ],
  "bids": [
    ["35020080080", "0.185784"], ["35020070060", "0.086916"], ["35020030010", "0.000071"]
  ],
  "lastTradePrice": "35077909990",
  "lastUpdate": 1726581829816
}
```

> همچنین اگر از SDK رسمی استفاده نمی‌کنید، در صورت اتصال و اشتراک صحیح، پیام‌های دریافتی از کانال به شکل زیر خواهد بود:

```json
{
  "push": {
    "channel": "public:orderbook-BTCIRT",
    "pub": {
      "data": {
        "asks": [
          ["35077909990", "0.009433"], ["35078000000", "0.000274"], ["35078009660", "0.00057"]
        ], 
        "bids": [
          ["35020080080", "0.185784"], ["35020070060", "0.086916"], ["35020030010", "0.000071"]
        ], 
        "lastTradePrice": "35077909990", 
        "lastUpdate": 1726581829816
      },
      "offset": 989153
    }
  }
}
```


**مثال:** برای دریافت تغییرات اردربوک بیت‌کوین به ریال، کافیست به کانال `public:orderbook-BTCIRT` متصل شوید.







**نکته مهم:** این کانال‌ها تنها در صورت وقوع تغییر در اردربوک پیام ارسال می‌کنند. بنابراین، در بازارهایی با حجم معاملات کم، ممکن است مدت زمان زیادی بین پیام‌ها فاصله باشد. به‌منظور رفع این مشکل توصیه می‌شود قبل از اشتراک در کانال‌های وب‌سوکت، یک بار اطلاعات اولیه اردربوک را از طریق [API اردربوک ورژن ۳](#orderbook-v3) دریافت کنید.


**توجه:** استفاده از فلگ <code dir="ltr">{ delta: 'fossil' }</code> در تابع `newSubscription` اختیاری است. با استفاده از این فلگ، اطلاعات اردربوک به صورت diff به کلاینت ارسال می‌شود. اگر از کلاینت‌های رسمی Centrifugo استفاده می‌کنید، متوجه تغییری نخواهید شد و صرفاً استفاده از پهنای باند شبکه‌ی شما کاهش چشم‌گیری در حدود ۶۰٪ خواهد کرد. اما در صورتی که از کلاینت رسمی استفاده نمی‌کنید، یا باید از استفاده از این فلگ خودداری کنید و یا باید حتماً الگوریتم بازیابی داده‌ها از حالت فشرده شده به حالت اصلی را پیاده‌سازی کنید. برای این کار از [الگوریتم فسیل](https://fossil-scm.org/) استفاده کرده‌ایم.

### پارامترهای پاسخ

 پیام‌های وب‌سوکت شامل دو آرایه `asks` و `bids` بوده که در هر یک قیمت و مقدار سفارش‌های بازار وجود دارد. سفارش‌های **خرید** در **`bids`** و سفارش‌های **فروش** در **`asks`** بازگردانده می‌شوند. هر یک از این آرایه‌ها شامل دوتایی‌های «قیمت، مقدار» هستند.


| پارامتر پاسخ       | نوع    | توضیحات                                               | نمونه                                                     |
|--------------------|--------|-------------------------------------------------------|-----------------------------------------------------------|
| `asks`             | array  | حاوی دوتایی‌های «قیمت، مقدار» از سفارش‌های **فروش**     | <code dir="ltr">[["1231", "0.1"],["1243", "1.02"]]</code> |
| `bids`             | array  | حاوی دوتایی‌های «قیمت، مقدار» از سفارش‌های **خرید**     | <code dir="ltr">[["1243", "1"],["1231", "2"]]</code>      |
| `lastTradePrice`   | string | مبلغ آخرین معامله                                     | <code dir="ltr">"35602702700"</code>                      |
| `lastUpdate`       | int    | زمان آخرین به‌روزرسانی به فرمت یونیکس                  | <code dir="ltr">1726651067347</code>                      |


<h2 id="websocket-trades">استریم معاملات</h2>

کانال‌هایی با پیشوند زیر شامل معاملات بازارها هستند و با انجام هر معامله، به مشترکین پیام ارسال می‌کنند:

**الگوی کانال‌های معاملات:** <code dir="ltr">public:trades-*</code>


```javascript
const sub = client.newSubscription('public:trades-BTCIRT', { delta: 'fossil' });
sub.on('subscribed', (ctx) => {
    console.log('subscribed');
});
sub.on('publication', (ctx) => {
    console.log(ctx.data);
});
sub.subscribe();
```

> در صورتی که از SDK استفاده نمی‌کنید پیام زیر را ارسال نمایید:

```json
{
  "id": 2,
  "subscribe": {
    "channel": "public:trades-BTCIRT"
  }
}
```

> که در کنسول، پیامی که `console.log` نموده‌اید به شکل زیر خواهد بود که همان مقدار `data` می‌باشد:

```json
{
  "time": 1728114934350,
  "price": "670000000000",
  "volume": "0.000001",
  "type":"buy"
}
```

> همچنین اگر از SDK رسمی استفاده نمی‌کنید، در صورت اتصال و اشتراک صحیح، پیام‌های دریافتی از کانال به شکل زیر خواهد بود:

```json
{
  "push": {
    "channel": "public:trades-BTCIRT",
    "pub": {
      "data": {
        "time": 1728114934350,
        "price": "67000000",
        "volume": "0.0112",
        "type": "buy"
      },
      "offset": 989153
    }
  }
}
```

<aside class="notice">
به‌جای <code>*</code> باید سمبل بازار مربوطه را به‌شکل UPPERCASE (حروف بزرگ) قرار دهید. مثلاً <code>BTCIRT</code> و یا <code>ETHUSDT</code> و ...
</aside>



**مثال:** برای دریافت معاملات بیت‌کوین به ریال، کافیست به کانال `public:trades-BTCIRT` متصل شوید.


### پارامترهای پاسخ


| پارامتر پاسخ | نوع    | توضیحات                                                                                                                                  | نمونه                                |
|--------------|--------|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
| `time`       | int    | زمان دقیق انجام شدن معامله با فرمت [یونیکس](https://fa.wikipedia.org/wiki/%D8%B3%D8%A7%D8%B9%D8%AA_%DB%8C%D9%88%D9%86%DB%8C%DA%A9%D8%B3) | <code dir="ltr">1728114934350</code> |
| `price`      | string | قیمت                                                                                                                                     | <code dir="ltr">"67000000"</code>    |
| `volume`     | string | حجم معامله                                                                                                                               | <code dir="ltr">"0.0112"</code>      |
| `type`       | string | نوع معامله (خرید یا فروش)                                                                                                                | <code dir="ltr">"buy"</code>         |

